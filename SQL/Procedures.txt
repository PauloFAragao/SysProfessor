USE dbprofessor

----------------------- Alunos -----------------------

--procedimento show, para mostrar os alunos
CREATE PROC sp_show_students
AS
SELECT TOP 75 * FROM alunos
ORDER BY numero ASC
GO

-- Procedimento para buscar aluno por nome
CREATE PROC spsearch_student_name
    @name VARCHAR(100)
AS
BEGIN
    SELECT * 
    FROM alunos 
    WHERE nome LIKE @name + '%' 
    ORDER BY numero ASC;
END
GO

--procedimento inserir aluno
CREATE PROCEDURE sp_insert_student_and_scores
    @name NVARCHAR(100),
    @num INT
AS
BEGIN
    DECLARE @idstudent INT;

    -- Adicionar aluno na tabela alunos
    INSERT INTO alunos (nome, numero) VALUES (@name, @num);

    -- Capturar o ID do aluno inserido
    SET @idstudent = SCOPE_IDENTITY();

    -- Inserir notas para cada matéria cadastrada
    INSERT INTO notas (idaluno, idmateria, notapt, notast, notatt, notaqt, media)
    SELECT @idstudent, idmateria, 0.00, 0.00, 0.00, 0.00, 0.00
    FROM materias;
END
GO

--procedimento editar aluno
CREATE PROC spedit_student
@idstudent INT,
@name VARCHAR(100),
@num INT
AS
UPDATE alunos
SET nome = @name, 
	numero = @num
WHERE idaluno = @idstudent
GO

--procedimento deletar aluno
CREATE PROC sp_del_studant
    @idstudent INT
AS
BEGIN
    DELETE FROM alunos
    WHERE idaluno = @idstudent;
END
GO

--procedimento para verificar a quantidade de alunos registrados
CREATE PROCEDURE sp_get_studants_amount
	@amount INT OUTPUT
AS
BEGIN
    SET @amount = 0;
    SELECT @amount = COUNT(*) FROM alunos;
END;
GO


----------------------- Materias -----------------------


--procedimento show, para mostrar as materias
CREATE PROC spshow_discipline
AS
SELECT TOP 75 * FROM materias
ORDER BY idmateria DESC
GO

--procedimento buscar materia por nome
CREATE PROC spsearch_discipline_name
@name VARCHAR(100)
AS 
SELECT * FROM materias WHERE nome LIKE @name+ '%'
GO

--procedimento inserir materia
--procedimento inserir materia
CREATE PROCEDURE sp_insert_discipline_and_scores
    @name NVARCHAR(100),
    @average DECIMAL(5, 2)
AS
BEGIN
    DECLARE @idmateria INT;

    -- Adicionar aluno na tabela alunos
    INSERT INTO materias (nome, media) VALUES (@name, @average);

    -- Capturar o ID do aluno inserido
    SET @idmateria = SCOPE_IDENTITY();

    -- Inserir notas para cada matéria cadastrada
    INSERT INTO notas (idaluno, idmateria, notapt, notast, notatt, notaqt, media)
    SELECT idaluno, @idmateria, 0.00, 0.00, 0.00, 0.00, 0.00
    FROM alunos;

END
GO

--procedimento editar materia
CREATE PROC spedit_discipline
@iddiscipline INT,
@name VARCHAR(100),
@average DECIMAL(5, 2)
AS
UPDATE materias
SET nome = @name, 
	media = @average
WHERE idmateria = @iddiscipline
GO

--procedimento deletar materia
CREATE PROC spdelete_discipline
@iddiscipline INT
AS
DELETE FROM materias 
WHERE idmateria = @iddiscipline
GO

--procedimento para verificar a quantidade de materias registrados
CREATE PROCEDURE sp_get_discipline_amount
	@amount INT OUTPUT
AS
BEGIN
    SET @amount = 0;
    SELECT @amount = COUNT(*) FROM materias;
END;
GO

----------------------- Notas -----------------------

--procedimento buscar notas por idaluno
CREATE PROC sp_search_scores_from_studant
	@idstudent INT
AS 
SELECT * FROM notas 
WHERE idaluno = @idstudent
ORDER BY idnotas ASC
GO

--procedimento buscar notas por materias
CREATE PROC sp_search_scores_from_discipline
	@iddiscipline INT
AS
SELECT * FROM notas 
WHERE idmateria = @iddiscipline
ORDER BY idnotas ASC
GO

--procedimento para buscar materias por nome e id do aluno
CREATE PROC sp_search_studentid_discipline
    @idstudent INT,
    @name VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT n.* 
    FROM notas n
    JOIN materias m ON n.idmateria = m.idmateria
    WHERE n.idaluno = @idstudent
      AND m.nome LIKE @name + '%' ;
END
GO

--procedimento para buscar alunos por nome e id da materia
CREATE PROC sp_search_disciplineid_student
    @iddiscipline INT,
    @name VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT n.* 
    FROM notas n
    JOIN alunos m ON n.idaluno = m.idaluno
    WHERE n.idmateria = @iddiscipline
      AND m.nome LIKE @name + '%' ;
END
GO

----------------------- Configurações -----------------------

--procedimento para ler as configurações
CREATE PROCEDURE sp_read_configurations
    @professor_name VARCHAR(100) OUTPUT,
    @scholl_name VARCHAR(100) OUTPUT
AS
BEGIN
    SET @professor_name = NULL;
    SET @scholl_name = NULL;

    IF EXISTS (SELECT 1 FROM dbo.configuracao)
    BEGIN
        SELECT TOP 1
            @professor_name = nome_professor,
            @scholl_name = nome_escola
        FROM dbo.configuracao;
    END
END;
GO

--prodecimento para editar as configurações
CREATE PROC spedit_configurations
@id_conf INT,
@professor_name VARCHAR(100),
@scholl_name VARCHAR(100)
as
UPDATE configuracao
SET nome_professor = @professor_name,
	nome_escola = @scholl_name
WHERE id = @id_conf
GO

--procedimento inserir configuração
CREATE PROC spinsert_configurations
@professor_name VARCHAR(100),
@scholl_name VARCHAR(100)
AS
INSERT INTO configuracao
VALUES (@professor_name, @scholl_name)
GO

--procedimento para verificar se existe alguma configuração e pegar o id
CREATE PROCEDURE sp_verify_configurations_data
    @Registered BIT OUTPUT,
    @Id INT OUTPUT
AS
BEGIN
    SET @Registered = 0;
    SET @Id = -1;

    IF EXISTS (SELECT 1 FROM dbo.configuracao)
    BEGIN
        SELECT TOP 1 @Id = id FROM dbo.configuracao;

        SET @Registered = 1;
    END
END;
GO